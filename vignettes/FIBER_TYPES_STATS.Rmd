---
title: "Statistical analyses of mean fiber area and fiber count by muscle and fiber type"
author: Tyler Sagendorf
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
bibliography: ../references.bib
csl: ../apa-numeric-superscript-brackets.csl
link-citations: yes
vignette: >
  %\VignetteIndexEntry{Statistical analyses of mean fiber area and fiber count by muscle and fiber type}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  message = FALSE,
  warning = FALSE
)
```

```{r setup}
# Required packages
library(MotrpacRatTrainingPhysiologyData)
library(ggplot2)
library(MASS)
library(dplyr)
library(tibble)
library(tidyr)
library(purrr)
library(emmeans)
library(lme4)
library(stats)
theme_set(theme_bw()) # base plot theme
```


# Plots

## Mean Fiber Area {.tabset}

### MG

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "MG") %>% 
  ggplot(aes(x = group, y = fiber_area)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type)
```

### LG

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "LG") %>% 
  ggplot(aes(x = group, y = fiber_area)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type)
```

### PL

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "PL") %>% 
  ggplot(aes(x = group, y = fiber_area)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type)
```

### SOL

```{r, fig.height=3.5, fig.width=3.5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "SOL") %>% 
  ggplot(aes(x = group, y = fiber_area)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type)
```


## Fiber Counts {.tabset}

### MG

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "MG") %>% 
  ggplot(aes(x = group, y = fiber_count / total_fiber_count)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type) +
  labs(y = "Proportion of fibers")
```

### LG

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "LG") %>% 
  ggplot(aes(x = group, y = fiber_count / total_fiber_count)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type) +
  labs(y = "Proportion of fibers")
```

### PL

```{r, fig.height=3.5, fig.width=5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "PL") %>% 
  ggplot(aes(x = group, y = fiber_count / total_fiber_count)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type) +
  labs(y = "Proportion of fibers")
```

### SOL

```{r, fig.height=3.5, fig.width=3.5}
# Plot points
FIBER_TYPES %>% 
  filter(muscle == "SOL") %>% 
  ggplot(aes(x = group, y = fiber_count / total_fiber_count)) +
  geom_point(na.rm = TRUE, alpha = 0.5,
             position = position_jitter(width = 0.1, height = 0)) +
  facet_grid(age + sex ~ type) +
  labs(y = "Proportion of fibers")
```


# Regression Models

## Mean Fiber Area

We will check the mean-variance relationship.

```{r}
mv <- FIBER_TYPES %>% 
  group_by(sex, group, age, muscle, type) %>% 
  summarise(mn = mean(fiber_area, na.rm = TRUE),
            vr = var(fiber_area, na.rm = TRUE))

fit.mv <- lm(log(vr) ~ log(mn), data = mv)
coef(fit.mv)
```

```{r, fig.height=4, fig.width=5}
plot(log(vr) ~ log(mn), data = mv, las = 1, pch = 19, 
     xlab = "log(group means)", ylab = "log(group variances)")
abline(coef(fit.mv), lwd = 2)
```

The slope of the line is close to 2, which suggests a gamma distribution may be appropriate. Since SOL only consists of type I and IIa fibers, we can not include an interaction between `muscle` and `type`, since it will be inestimable for SOL type IIb and IIx. Instead, we will create a new `muscle_type` variable by concatenating `muscle` and `type`. We also need to remove rat 10046461, since it is missing a SOL type IIa measure of fiber area since none of the fibers were classified as such (`fiber_count` = 0).

```{r}
FIBER_TYPES <- mutate(FIBER_TYPES, muscle_type = paste0(muscle, "_", type))

fit.area <- glm(fiber_area ~ (age + sex + group + muscle_type) ^ 4,
                family = Gamma("log"),
                data = FIBER_TYPES)
plot_lm(fit.area)
```

We will try to simplify the model to fix problems with the diagnostic plots.

```{r}
anova(fit.area, test = "F")
```

```{r}
fit.area.1 <- update(fit.area, 
                     formula = . ~ muscle_type * age * (sex + group) + sex:group)
anova(fit.area.1, fit.area, test = "F")
```

There is no significant difference between the models, so we will use the simpler one.

```{r}
fit.area <- fit.area.1
plot_lm(fit.area)
```

Simplifying the model did not fix the heavy right tail of the QQ-plot, so we will investigate these observations further.

```{r}
FIBER_TYPES[which(residuals(fit.area.1) >= 0.3), ]
```

The outlying observations are from the same animal! Indeed, rat 06M8T11 has the highest or second-highest type muscle fiber areas of the 8-week-trained 6M males. This is primarily observed in the IIb and IIx MG and PL, which may suggest that this rat was exercised above 70-75% VO2max. Looking at the VO2max testing data, this rat had the highest absolute VO2max post-training, one of the highest post-training VO2max relative to total body mass, and MRS of 32.4 m/min. We will exclude this rat since doing so will bring the means of the 8W groups closer to SED, so the results will be more conservative. 

```{r}
fit.area <- update(fit.area, subset = iowa_id != "06M8T11")
plot_lm(fit.area)
```

The diagnostic plots look fine.

```{r}
summary(fit.area)
```


## Fiber Counts

We will use a log-link Poisson GLM with `log(total_fiber_count)` as an offset so that counts get converted to proportion of total fibers. We will first check the mean-variance relationship.

```{r}
mv <- FIBER_TYPES %>% 
  group_by(sex, group, age, muscle, type) %>% 
  summarise(mn = mean(fiber_count, na.rm = TRUE),
            vr = var(fiber_count, na.rm = TRUE))

fit.mv <- lm(log(vr) ~ log(mn), data = mv)
coef(fit.mv)
```

```{r, fig.height=4, fig.width=5}
plot(log(vr) ~ log(mn), data = mv, las = 1, pch = 19, 
     xlab = "log(group means)", ylab = "log(group variances)")
abline(coef(fit.mv), lwd = 2)
```

The slope suggests a variance function approximately of the form $Var(\mu) = \mu^{1.5}$. Since we are dealing with count data, and the regular Poisson distribution only has a variance function of the form $Var(\mu) = \mu$, we will use a quasi-Poisson distribution.

```{r}
fit.count <- glm(fiber_prop ~ (age + sex + group + muscle_type) ^ 4,
                 family = poisson("log"),
                 offset = log(total_fiber_count),
                 data = filter(FIBER_TYPES, muscle %in% c("SOL", "PL")))
plot(fit.count)
```


# Comparisons

We will compare the 8W trained to the sedentary control group within each age, sex, and muscle. We will then adjust p-values across fiber types within each age, sex, and muscle group using the Holm method.

We will also perform all pairwise fiber type comparisons within each sex, age, muscle, and timepoint group. The Tukey multiple comparison adjustment is used.

```{r}
## Create emm_list objects
# FIBER_TYPES_EMM <- model_list <-
#   list("Fiber Type Area" = fit) %>%
#   list() %>%
#   rep(2) %>%
#   setNames(c("group", "type"))
# specs <- list("trained_vs_SED" = "group")#, 
# "pairwise_fiber_types" = "type")
model_list <- list("Fiber CSA" = fit.area)

FIBER_TYPES_EMM <- map(model_list, function(mod_i) {
  emmeans(mod_i, specs = "group", by = c("age", "sex", "muscle_type"),
          type = "response", infer = TRUE)
})


# FIBER_TYPES_STATS <- FIBER_TYPES_EMM <- 
#   list("Fiber Area" = fit.area,
#        "% Fiber Type" = fit.count) %>% 
#   map(function(mod_i) { 
#     terms_i <- attr(terms(mod_i), which = "term.labels")
#     by <- intersect(c("muscle_type", "sex", "age"), terms_i)
#     # by <- setdiff(by, "group")
#     
#     emmeans(mod_i, specs = "group", by = by, type = "response")
#   })
# 
# emmeans(fit.area, specs = "group", by = c("muscle_type", "sex", "age"),
#         type = "response") %>% 
#   contrast(method = "trt.vs.ctrl") %>% 
#   summary(infer = TRUE) %>% 
#   as.data.frame() %>% 
#   View()

# 8W / SED comparisons within each combination of 
# age, sex, and muscle (Holm adjustment across fiber types)
# FIBER_TYPES_STATS[[2]] <- FIBER_TYPES_STATS[[2]] %>% 
#   contrast(method = "trt.vs.ctrl") %>% 
#   summary(infer = TRUE) %>% 
#   as.data.frame() #%>% 
# group_by(age, sex, muscle_type) %>% 
# mutate(p.value = p.adjust(p.value, method = "holm")) %>% 
# ungroup()

# All pairwise fiber type comparisons within each combination of 
# age, sex, group, and muscle (Tukey multiple comparison adjustment)
# FIBER_TYPES_STATS[[2]] <- FIBER_TYPES_STATS[[2]] %>% 
#   pairs() %>% 
#   summary(infer = TRUE) %>% 
#   as.data.frame()
# 
# FIBER_TYPES_STATS <- map(FIBER_TYPES_STATS, function(res) {
#   res %>% 
#     mutate(signif = cut(p.value,
#                         breaks = c(0, 0.001, 0.01, 0.05, 1),
#                         labels = c("***", "**", "*", ""),
#                         include.lowest = TRUE, right = FALSE,
#                         ordered_result = TRUE)) %>% 
#     pivot_longer(cols = contains(".ratio"), 
#                  names_to = "statistic_type", 
#                  values_to = "statistic", 
#                  values_drop_na = TRUE) %>% 
#     relocate(starts_with("statistic"), .before = p.value)
# })
```


```{r}
# Extract model info
model_df <- map_chr(model_list, .f = ~ paste(deparse(.x[["call"]]), 
                                      collapse = "")) %>% 
  enframe(name = "response", 
          value = "model") %>% 
  mutate(model = gsub("(?<=[\\s])\\s*|^\\s+|\\s+$", "", model, perl = TRUE),
         model_type = sub("^([^\\(]+).*", "\\1", model),
         formula = sub(".*formula = ([^,]+),.*", "\\1", model),
         family = sub(".*family = ([^\\)]+\\)),.*", "\\1", model),
         family = ifelse(model_type == "lm", "gaussian", family),
         # if weights were used, they were inverse group variances
         weights = ifelse(grepl("weights = ", model), 
                          "inverse group variances", NA)) %>% 
  dplyr::select(-model)

FIBER_TYPES_STATS <- FIBER_TYPES_EMM %>% 
  map(function(emm_i) {
    contrast(emm_i, method = "dunnett") %>% 
      summary(infer = TRUE) %>% 
      as.data.frame() %>% 
      rename(any_of(c(lower.CL = "asymp.LCL",
                      upper.CL = "asymp.UCL")))
  }) %>% 
  enframe(name = "response") %>% 
  unnest(value) %>% 
  mutate(muscle = sub("_.*", "", muscle_type),
         type = sub(".*_", "", muscle_type),
         muscle_type = NULL) %>% 
  group_by(age, sex, muscle) %>% 
  mutate(p.value = p.adjust(p.value, method = "holm"),
         signif = cut(p.value,
                      breaks = c(0, 0.001, 0.01, 0.05, 1),
                      labels = c("***", "**", "*", ""),
                      include.lowest = TRUE, right = FALSE,
                      ordered_result = TRUE)) %>%
  ungroup() %>% 
  left_join(model_df, by = "response") %>% 
  relocate(muscle, type, .after = sex) %>% 
  pivot_longer(cols = contains(".ratio"), 
               names_to = "statistic_type", 
               values_to = "statistic", 
               values_drop_na = TRUE) %>% 
  relocate(starts_with("statistic"), .before = p.value) %>% 
  relocate(signif, .after = p.value) %>% 
  relocate(ends_with("CL", ignore.case = FALSE), .before = null) %>% 
  arrange(response, age, sex, muscle, type)
```

See `?FIBER_TYPES_STATS` for details.

```{r}
print.data.frame(head(FIBER_TYPES_STATS))
# map(FIBER_TYPES_STATS, ~ print.data.frame(head(.x)))
```

```{r, eval=FALSE, include=FALSE}
# Save data
usethis::use_data(FIBER_TYPES_EMM, internal = FALSE, overwrite = TRUE,
                  compress = "bzip2", version = 3)

usethis::use_data(FIBER_TYPES_STATS, internal = FALSE, overwrite = TRUE,
                  compress = "bzip2", version = 3)
```

# Session Info

```{r}
sessionInfo()
```

# References

