---
title: "Plots of weekly total body mass and blood lactate"
author: Tyler Sagendorf
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 1.7, 
  fig.width = 3.8,
  out.height = "70%",
  out.width = "70%",
  dpi = 400,
  message = FALSE,
  warning = FALSE
)
```

```{r setup}
# Required packages
library(MotrpacRatTrainingPhysiologyData)
library(dplyr)
library(ggplot2)
library(tidyr)
library(emmeans)
```


# Body Weight {.tabset}

Body weight was measured at the start of each week prior to training.

```{r include=FALSE, eval=FALSE, echo=FALSE}
# WEEKLY_MEASURES %>% 
#   filter(age == "6M", group == "SED", omics_analysis) %>% 
#   ggplot(aes(x = as.factor(week), y = weight)) + 
#   geom_line(aes(group = pid), lty = "dashed", linewidth = 0.3, alpha = 0.7) +
#   geom_point(na.rm = TRUE, size = 1.5, shape = 16, aes(color = sex),
#              position = ggbeeswarm::position_beeswarm(cex = 2, 
#                                                       dodge.width = 0.1)) +
#   scale_color_manual(values = c("#ff6eff", "#5555ff"),
#                      breaks = c("Female", "Male")) +
#   guides(color = guide_none()) +
#   facet_wrap(~ sex, scales = "free", ncol = 1, strip.position = "right") +
#   labs(x = "Week", 
#        y = "Body Mass (g)") +
#   theme_bw() +
#   theme(strip.background = element_blank(),
#         axis.ticks.x = element_blank(),
#         panel.grid.major.x = element_blank())
# 
# ggsave("../../plots/6M_SED_weekly_body_weight_omics.png", 
#        height = 3, width = 5, dpi = 400, bg = "white")
```


## 6M Female

```{r}
WEEKLY_WEIGHT_EMM %>% 
  filter(age == "6M", sex == "Female") %>% 
  ggplot(aes(x = week, y = y)) +
  geom_crossbar(aes(ymin = ymin, ymax = ymax),
                fatten = 1, color = "#ff6eff", 
                width = 0.7, linewidth = 0.4) +
  geom_text(data = left_join(WEEKLY_WEIGHT_STATS, WEEKLY_WEIGHT_EMM, 
                             by = c("age", "sex", "group", "week")) %>% 
              filter(age == "6M", sex == "Female"), 
            aes(x = week, y = ymax, label = signif),
            size = 3, vjust = 0) +
  facet_grid(~ group) +
  scale_y_continuous(name = "Body Mass (g)",
                     expand = expansion(mult = 5e-3),
                     breaks = seq(180, 210, 10)) +
  coord_cartesian(ylim = c(175, 210), clip = "off") +
  labs(x = "Week") +
  theme_bw(base_size = 6.5) +
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 5.5),
        axis.title = element_text(color = "black", size = 6),
        axis.ticks = element_line(color = "black"),
        axis.ticks.x = element_blank(),
        strip.text = element_text(color = "black", size = 7),
        strip.background = element_blank(),
        panel.spacing = unit(-1, "pt"),
        panel.grid = element_blank())

ggsave("../../plots/weekly_body_mass_6M_female.png",
       height = 1.7, width = 3.8, dpi = 400)
```

## 6M Male

```{r}
WEEKLY_WEIGHT_EMM %>% 
  filter(age == "6M", sex == "Male") %>% 
  ggplot(aes(x = week, y = y)) +
  geom_crossbar(aes(ymin = ymin, ymax = ymax),
                fatten = 1, color = "#5555ff", 
                width = 0.7, linewidth = 0.4) +
  geom_text(data = left_join(WEEKLY_WEIGHT_STATS, WEEKLY_WEIGHT_EMM, 
                             by = c("age", "sex", "group", "week")) %>% 
              filter(age == "6M", sex == "Male"), 
            aes(x = week, y = ymax, label = signif),
            size = 3, vjust = 0) +
  facet_grid(~ group) +
  scale_y_continuous(name = "Body Mass (g)",
                     breaks = seq(300, 370, 10),
                     expand = expansion(mult = 5e-3)) +
  coord_cartesian(ylim = c(308, 376), clip = "off") +
  labs(x = "Week") +
  theme_bw(base_size = 6.5) +
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 5.5),
        axis.title = element_text(color = "black", size = 6),
        axis.ticks = element_line(color = "black"),
        axis.ticks.x = element_blank(),
        strip.text = element_text(color = "black", size = 7),
        strip.background = element_blank(),
        panel.spacing = unit(-1, "pt"),
        panel.grid = element_blank())

ggsave("../../plots/weekly_body_mass_6M_male.png",
       height = 1.7, width = 3.8, dpi = 400)
```

## 18M Female

```{r}
WEEKLY_WEIGHT_EMM %>% 
  filter(age == "18M", sex == "Female") %>% 
  ggplot(aes(x = week, y = y)) +
  geom_crossbar(aes(ymin = ymin, ymax = ymax),
                fatten = 1, color = "#ff6eff", 
                width = 0.7, linewidth = 0.4) +
  geom_text(data = left_join(WEEKLY_WEIGHT_STATS, WEEKLY_WEIGHT_EMM, 
                             by = c("age", "sex", "group", "week")) %>% 
              filter(age == "18M", sex == "Female"), 
            aes(x = week, y = ymax, label = signif),
            size = 3, vjust = 0) +
  facet_grid(~ group) +
  scale_y_continuous(name = "Body Mass (g)",
                     breaks = seq(220, 250, 10),
                     expand = expansion(mult = 5e-3)) +
  coord_cartesian(ylim = c(220, 255), clip = "off") +
  labs(x = "Week") +
  theme_bw(base_size = 6.5) +
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 5.5),
        axis.title = element_text(color = "black", size = 6),
        axis.ticks = element_line(color = "black"),
        axis.ticks.x = element_blank(),
        strip.text = element_text(color = "black", size = 7),
        strip.background = element_blank(),
        panel.spacing = unit(-1, "pt"),
        panel.grid = element_blank())

ggsave("../../plots/weekly_body_mass_18M_female.png",
       height = 1.7, width = 3.8, dpi = 400)
```

## 18M Male

```{r}
WEEKLY_WEIGHT_EMM %>% 
  filter(age == "18M", sex == "Male") %>% 
  ggplot(aes(x = week, y = y)) +
  geom_crossbar(aes(ymin = ymin, ymax = ymax),
                fatten = 1, color = "#5555ff", 
                width = 0.7, linewidth = 0.4) +
  geom_text(data = left_join(WEEKLY_WEIGHT_STATS, WEEKLY_WEIGHT_EMM, 
                             by = c("age", "sex", "group", "week")) %>% 
              filter(age == "18M", sex == "Male"), 
            aes(x = week, y = ymax, label = signif),
            size = 3, vjust = 0) +
  facet_grid(~ group) +
  scale_y_continuous(name = "Body Mass (g)",
                     breaks = seq(380, 440, 20),
                     expand = expansion(mult = 5e-3)) +
  coord_cartesian(ylim = c(375, 450), clip = "off") +
  labs(x = "Week") +
  theme_bw(base_size = 6.5) +
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 5.5),
        axis.title = element_text(color = "black", size = 6),
        axis.ticks = element_line(color = "black"),
        axis.ticks.x = element_blank(),
        strip.text = element_text(color = "black", size = 7),
        strip.background = element_blank(),
        panel.spacing = unit(-1, "pt"),
        panel.grid = element_blank())

ggsave("../../plots/weekly_body_mass_18M_male.png",
       height = 1.7, width = 3.8, dpi = 400)
```



# Lactate {.tabset}

Blood lactate was recorded at the start (prior to any training) and end of each week. For the SED group, blood lactate was only recorded in 18M males, so we will not plot SED values.

```{r}
lact_df <- WEEKLY_MEASURES %>% 
  dplyr::select(pid, age, sex, group, week, week_time, lactate) %>% 
  distinct() %>% 
  filter(!is.na(lactate)) %>%  
  filter(group != "SED") %>% 
  mutate(week_time = factor(week_time, levels = c("start", "end"),
                            labels = c("Start", "End")),
         week = factor(week, levels = 1:8, labels = paste0("", 1:8))) %>% 
  droplevels.data.frame() %>% 
  group_by(age, sex, group, week, week_time) %>%
  mutate(n = n()) %>% 
  filter(week_time == "Start")
```

```{r}
# Reusable lactate plot code
f1 <- function(x) {
  ggplot() +
    stat_summary(geom = "crossbar", fun.data = mean_cl_normal, 
                 data = filter(x, n >= 5),
                 mapping = aes(x = week, y = lactate, color = sex),
                 width = 0.8, linewidth = 0.5, fatten = 1) +
    geom_point(aes(x = week, y = lactate, color = sex),
               data = filter(x, n < 5),
               position = ggbeeswarm::position_beeswarm(cex = 2, 
                                                        dodge.width = 0.7),
               shape = 16, size = 0.5) + 
    facet_grid(~ group, space = "free", scales = "free") +
    scale_color_manual(values = c("#ff6eff", "#5555ff"),
                       breaks = c("Female", "Male")) +
    labs(x = "Week") +
    theme_bw() +
    theme(text = element_text(size = 6.5, color = "black"),
          line = element_line(linewidth = 0.3, color = "black"),
          axis.ticks = element_line(linewidth = 0.3, color = "black"),
          panel.grid = element_blank(),
          # panel.border = element_blank(),
          panel.border = element_rect(color = "black", fill = NA, 
                                      linewidth = 0.3),
          axis.ticks.x = element_blank(),
          axis.text = element_text(size = 5,
                                   color = "black"),
          axis.title = element_text(size = 6.5, margin = margin(),
                                    color = "black"),
          # axis.line = element_line(color = "black", linewidth = 0.3),
          strip.background = element_blank(),
          strip.text = element_text(size = 7, color = "black",
                                    margin = margin(b = 2, t = 2)),
          panel.spacing = unit(3, "pt"),
          legend.position = "none"
    )
}
```

## 6M Female

```{r}
# 6M Female
lact_df %>% 
  filter(age == "6M", sex == "Female") %>% 
  f1() + 
  scale_y_continuous(name = "Lactate (mM)",
                     expand = expansion(mult = 5e-3),
                     breaks = seq(0, 8, 2)) +
  coord_cartesian(ylim = c(0, 8), clip = "off")

ggsave("../../plots/weekly_lactate_6M_female.png", 
       height = 1.7, width = 3.8, dpi = 400)
```

## 6M Male

```{r}
# 6M Male
lact_df %>% 
  filter(age == "6M", sex == "Male") %>% 
  f1() +
  coord_cartesian(ylim = c(0, 12), clip = "off") +
  scale_y_continuous(name = "Lactate (mM)",
                     breaks = seq(0, 12, 4),
                     expand = expansion(mult = 5e-3))

ggsave("../../plots/weekly_lactate_6M_male.png", 
       height = 1.7, width = 3.8, dpi = 400)
```

## 18M Female

```{r}
# 18M Female
lact_df %>% 
  filter(age == "18M", sex == "Female") %>% 
  f1() +
  coord_cartesian(ylim = c(0, 12), clip = "off") +
  scale_y_continuous(name = "Lactate (mM)",
                     breaks = seq(0, 12, 4),
                     expand = expansion(mult = 5e-3))

ggsave("../../plots/weekly_lactate_18M_female.png", 
       height = 1.7, width = 3.8, dpi = 400)
```

## 18M Male

```{r}
# 18M Male
lact_df %>% 
  filter(age == "18M", sex == "Male") %>% 
  f1() +
  coord_cartesian(ylim = c(0, 8), clip = "off") +
  scale_y_continuous(name = "Lactate (mM)",
                     breaks = seq(0, 8, 2),
                     expand = expansion(mult = 5e-3))

ggsave("../../plots/weekly_lactate_18M_male.png", 
       height = 1.7, width = 3.8, dpi = 400)
```

